generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                       String  @id @default(uuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  refresh_token_expires_in Int?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model User {
  id              String            @id @unique @default(uuid())
  firstname       String?
  lastname        String?
  username        String            @unique
  role            Role              @default(USER)
  createAt        DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  phone           String            @unique
  avatar          String?
  email           String?           @unique
  accounts        Account[]
  carts           Cart[]            @relation("UserCarts")
  comments        Comment[]
  instructor      Instructor?
  payments        Payment[]         @relation("UserToPayments")
  questions       Question[]
  sessionProgress SessionProgress[] @relation("SessionProgress")
  tickets         Ticket[]
  ticketReplies   TicketReply[]
  courses         UserCourse[]      @relation("UserCourses")
  terms           UserTerm[]        @relation("UserTerms")
  userDiscount      UserDiscount[]
}

model Course {
  id               Int          @id @unique @default(autoincrement())
  title            String
  subtitle         String
  description      String
  cover            String
  isHighPriority   Boolean      @default(false)
  shortAddress     String       @unique
  sessionCount     Int          @default(0)
  level            CourseLevel
  participants     Int          @default(0)
  rating           Float?       @default(5.0)
  status           CourseStatus
  instructorId     Int
  introVideoUrl    String?
  createAt         DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  shortDescription String?
  activeStatus     Boolean      @default(false)
  duration         Int          @default(0)
  price            Int?
  cartCourses      CartCourse[] @relation("CourseToCartCourses")
  comments         Comment[]
  instructor       Instructor   @relation(fields: [instructorId], references: [id])
  courseTerms      CourseTerm[] @relation("CourseToTerms")
  questions        Question[]
  tickets          Ticket[]
  users            UserCourse[] @relation("UserCourses")
  discountCodes DiscountCode[] 
}

model UserCourse {
  id          Int            @id @default(autoincrement())
  userId      String
  courseId    Int
  purchasedAt DateTime       @default(now())
  status      PurchaseStatus @default(ACTIVE)
  course      Course         @relation("UserCourses", fields: [courseId], references: [id], onDelete: Cascade)
  user        User           @relation("UserCourses", fields: [userId], references: [id] , onDelete: Cascade)

  @@unique([userId, courseId])
}

model Term {
  id          Int          @id @unique @default(autoincrement())
  name        String
  createAt    DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  duration    Int          @default(0)
  subtitle    String?
  discount    Int?         @default(0)
  price       Int          @default(0)
  cartTerms   CartTerm[]   @relation("CartToTerms")
  courseTerms CourseTerm[] @relation("TermToCourses")
  sessions    Session[]    @relation("TermToSessions")
  userTerms   UserTerm[]   @relation("UserTerms")
}

model CourseTerm {
  id         Int      @id @unique @default(autoincrement())
  courseId   Int
  termId     Int
  isOptional Boolean  @default(false)
  createAt   DateTime @default(now())
  updatedAt  DateTime @updatedAt
  course     Course   @relation("CourseToTerms", fields: [courseId], references: [id] , onDelete: Cascade)
  term       Term     @relation("TermToCourses", fields: [termId], references: [id] , onDelete: Cascade)

  @@unique([courseId, termId])
}

model Session {
  id              String            @id @unique @default(uuid())
  name            String
  termId          Int
  isFree          Boolean           @default(false)
  createAt        DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  duration        Int
  videoId         Int?              @unique
  order           Int               @default(0)
  isActive        Boolean           @default(false)
  questions       Question[]
  term            Term              @relation("TermToSessions", fields: [termId], references: [id] , onDelete: Cascade)
  video           SessionVideo?     @relation("SessionToVideo", fields: [videoId], references: [id])
  sessionProgress SessionProgress[] @relation("SessionProgress")
}

model SessionVideo {
  id          Int              @id @unique @default(autoincrement())
  videoKey    String
  accessLevel VideoAccessLevel @default(REGISTERED)
  status      VideoStatus      @default(AVAILABLE)
  createAt    DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  session     Session?         @relation("SessionToVideo")
}

model SessionProgress {
  id          Int      @id @default(autoincrement())
  userId      String
  sessionId   String
  isCompleted Boolean  @default(false)
  createAt    DateTime @default(now())
  updatedAt   DateTime @updatedAt
  session     Session  @relation("SessionProgress", fields: [sessionId], references: [id], onDelete: Cascade)
  user        User     @relation("SessionProgress", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, sessionId])
}

model Question {
  id           String    @id @default(uuid())
  userId       String
  courseId     Int
  sessionId    String
  questionText String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  answerText   String?
  answeredAt   DateTime?
  isAnswered   Boolean   @default(false)
  isReadByUser Boolean   @default(false)
  course       Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  session      Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Instructor {
  id        Int      @id @unique @default(autoincrement())
  userId    String   @unique
  describe  String?
  bio       String?
  skills    String?
  createAt  DateTime @default(now())
  updatedAt DateTime @updatedAt
  courses   Course[]
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserTerm {
  id          Int      @id @default(autoincrement())
  userId      String
  termId      Int
  purchasedAt DateTime @default(now())
  term        Term     @relation("UserTerms", fields: [termId], references: [id], onDelete: Cascade)
  user        User     @relation("UserTerms", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, termId])
}

model Cart {
  id            Int          @id @unique @default(autoincrement())
  userId        String
  status        CartStatus   @default(PENDING)
  totalPrice    Int?
  totalDiscount Int?
  discountCodeId  Int? 
  discountCodeAmount Int?
  createAt      DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  discountAppliedAt DateTime?
  user          User         @relation("UserCarts", fields: [userId], references: [id], onDelete: Cascade)
  cartCourses   CartCourse[] @relation("CartToCourses")
  cartTerms     CartTerm[]   @relation("CartToCartTerms")
  payment       Payment?     @relation("CartToPayment")
}

model CartCourse {
  id       Int    @id @unique @default(autoincrement())
  cartId   Int
  courseId Int
  cart     Cart   @relation("CartToCourses", fields: [cartId], references: [id], onDelete: Cascade)
  course   Course @relation("CourseToCartCourses", fields: [courseId], references: [id], onDelete: Cascade)
}

model CartTerm {
  id        Int      @id @unique @default(autoincrement())
  cartId    Int
  termId    Int
  price     Int
  discount  Int?
  createAt  DateTime @default(now())
  updatedAt DateTime @updatedAt
  cart      Cart     @relation("CartToCartTerms", fields: [cartId], references: [id])
  term      Term     @relation("CartToTerms", fields: [termId], references: [id], onDelete: Cascade)

  @@unique([cartId, termId])
}

model Payment {
  id            Int           @id @unique @default(autoincrement())
  userId        String
  cartId        Int           @unique
  amount        Int
  status        PaymentStatus
  method        PaymentMethod
  authority     String?       @unique
  createAt      DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  transactionId BigInt?
  cart          Cart          @relation("CartToPayment", fields: [cartId], references: [id])
  user          User          @relation("UserToPayments", fields: [userId], references: [id], onDelete: Cascade)
}

model Comment {
  id        Int           @id @default(autoincrement())
  content   String
  userId    String
  courseId  Int?
  articleId Int?
  parentId  Int?
  createAt  DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  status    CommentStatus @default(PENDING)
  article   Article?      @relation(fields: [articleId], references: [id], onDelete: Cascade)
  course    Course?       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  parent    Comment?      @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[]     @relation("CommentReplies")
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Article {
  id        Int       @id @default(autoincrement())
  title     String
  content   String
  createAt  DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  cover     String
  readTime  Int
  shortAddress String @unique
  isActive  Boolean @default(false)
  subtitle  String
  comments  Comment[]
}

model VerificationCode {
  id        Int      @id @default(autoincrement())
  phone     String   @unique
  expiresAt DateTime
  code      Int
}

model FAQ {
  id        Int         @id @default(autoincrement())
  question  String
  answer    String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  category  CategoryFAQ @default(GENERAL)
}

model Newsletter {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  userId    String?
  createdAt DateTime @default(now())

  @@index([email])
}

model Ticket {
  title         String
  description   String
  status        TicketStatus  @default(PENDING)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  userId        String
  courseId      Int?
  id            Int           @id @default(autoincrement())
  course        Course?       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  ticketReplies TicketReply[]
}

model TicketReply {
  content   String
  createdAt DateTime      @default(now())
  userId    String
  id        Int           @id @default(autoincrement())
  ticketId  Int
  parentId  Int?
  parent    TicketReply?  @relation("ParentReply", fields: [parentId], references: [id])
  children  TicketReply[] @relation("ParentReply")
  ticket    Ticket        @relation(fields: [ticketId], references: [id])
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VisitLog {
  id        Int      @id @default(autoincrement())
  ipAddress String
  userAgent String
  pageUrl   String
  referrer  String?
  visitedAt DateTime @default(now())
}

model SiteInfo {
  id               Int      @id @default(autoincrement())
  shortDescription String
  fullDescription  String
  rules            String?
  companyAddress   String?
  companyEmail     String
  socialLinks      Json?
  heroImage        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  articlesLinks    Json?
  coursesLinks     Json?
  usefulLinks      Json?
  companyPhone     String?
}

model SeoSetting {
  id        Int      @id @default(autoincrement())
  page      String
  key       String
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([page, key])
}

model SitemapSetting {
  id          Int      @id @default(autoincrement()) // شناسه یکتا
  section     String   // نام بخش (مانند "homepage", "blog", "courses")
  shortAddress String?
  changefreq  String   // فرکانس تغییر (مانند "daily", "weekly", "monthly")
  priority    Float    // اولویت صفحه (مقدار بین 0.1 تا 1.0)
  createdAt   DateTime @default(now())              // تاریخ ایجاد
  updatedAt   DateTime @updatedAt                  // تاریخ آخرین بروزرسانی

  @@unique([section]) // جلوگیری از ثبت مقادیر تکراری برای هر بخش و نوع
}

model DiscountCode {
  id                Int       @id @default(autoincrement()) // شناسه یکتا
  title             String    // عنوان کد تخفیف
  code              String    @unique // کد تخفیف (باید یکتا باشد)
  discountPercent   Float     // درصد تخفیف (مثلاً 20 برای 20%)
  maxDiscountAmount Float?    // سقف مبلغ تخفیف (اختیاری)
  usageLimit        Int?      // سقف تعداد استفاده (اختیاری)
  usageCount        Int       @default(0) // تعداد استفاده‌شده
  minPurchaseAmount Float?    // حداقل مبلغ لازم برای استفاده از تخفیف (اختیاری)
  expiryDate        DateTime? // تاریخ انقضا (اختیاری)
  description       String?   // توضیحات کد تخفیف (اختیاری)
  courseId          Int?      // ارتباط با دوره خاص (اختیاری)
  course            Course?   @relation(fields: [courseId], references: [id], onDelete: Cascade) // رابطه با مدل Course
  isActive          Boolean   @default(true) // وضعیت فعال/غیرفعال بودن کد تخفیف
  createdAt         DateTime  @default(now()) // تاریخ ایجاد
  updatedAt         DateTime  @updatedAt      // تاریخ به‌روزرسانی
  userDiscount      UserDiscount[]
}

model UserDiscount {
  id             Int          @id @default(autoincrement()) // شناسه یکتا
  userId         String       // شناسه کاربر
  discountCodeId Int          // شناسه کد تخفیف
  usedAt         DateTime     @default(now()) // تاریخ استفاده
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  discountCode   DiscountCode @relation(fields: [discountCodeId], references: [id], onDelete: Cascade)

  @@unique([userId, discountCodeId]) // هر کاربر فقط یک بار می‌تواند از یک کد تخفیف استفاده کند
}


enum Role {
  USER
  ADMIN
  MANAGER
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  BEGINNER_INTERMEDIATE
  INTERMEDIATE_ADVANCED
}

enum CourseStatus {
  COMPLETED
  IN_PROGRESS
}

enum PurchaseStatus {
  ACTIVE
  CANCELLED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  SUCCESSFUL
  FAILED
}

enum PaymentMethod {
  CREDIT_CARD
  ONLINE
  FREE
}

enum CartStatus {
  PENDING
  PAID
  CANCELLED
  COMPLETED
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TicketStatus {
  PENDING
  IN_PROGRESS
  CLOSED
  ANSWERED
  OPEN
}

enum CategoryFAQ {
  COURSE
  ONLINE_CLASS
  GENERAL
}

enum VideoAccessLevel {
  PUBLIC
  REGISTERED
  PURCHASED
}

enum VideoStatus {
  AVAILABLE
  UNAVAILABLE
}
